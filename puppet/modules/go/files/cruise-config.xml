<?xml version="1.0" encoding="utf-8"?>
<cruise xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="cruise-config.xsd" schemaVersion="55">
  <server artifactsdir="artifacts" serverId="106df03c-634c-4857-92a6-af150fbbb0d7" />
  <pipelines group="OpenMRS-CPM">
    <pipeline name="CPM-Module" labeltemplate="${COUNT}-${git}" isLocked="true">
      <environmentvariables>
        <variable name="JAVA_HOME">
          <value>/usr/java/latest</value>
        </variable>
      </environmentvariables>
      <materials>
        <git url="https://github.com/johnsyweb/openmrs-cpm.git" materialName="git" />
      </materials>
      <stage name="Package">
        <jobs>
          <job name="Package">
            <tasks>
              <exec command="./go" args="clean package">
                <runif status="passed" />
              </exec>
            </tasks>
            <artifacts>
              <artifact src="**/cpm-*.omod" />
            </artifacts>
          </job>
        </jobs>
      </stage>
    </pipeline>
    <pipeline name="Infrastructure" isLocked="true">
      <environmentvariables>
        <variable name="SETTINGS_FILE">
          <value>/var/go/settings.yaml</value>
        </variable>
      </environmentvariables>
      <materials>
        <git url="https://github.com/khaong/configuration-master" />
      </materials>
      <stage name="PuppetSyntax">
        <jobs>
          <job name="PuppetSyntax">
            <tasks>
              <exec command="./go" args="test:puppet_syntax" />
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="Package">
        <jobs>
          <job name="Package">
            <tasks>
              <exec command="./go" args="package:puppet" />
            </tasks>
            <artifacts>
              <artifact src="build/boot.tar.gz" dest="build" />
            </artifacts>
          </job>
        </jobs>
      </stage>
      <stage name="Publish">
        <jobs>
          <job name="Publish">
            <tasks>
              <fetchartifact pipeline="Infrastructure" stage="Package" job="Package" srcdir="build">
                <runif status="passed" />
              </fetchartifact>
              <exec command="./go" args="aws:publish_bootstrap" />
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>
  </pipelines>
</cruise>